{% extends "base.html" %}

{% block title %}Manage Leave Applications{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Manage Leave Applications</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#bulkActionModal">
                        <i data-feather="layers" class="me-2"></i>Bulk Actions
                    </button>
                    <a href="{{ url_for('leave.leave_reports') }}" class="btn btn-outline-primary">
                        <i data-feather="bar-chart-2" class="me-2"></i>Leave Reports
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="row mb-4">
        <div class="col-md-3">
            <select class="form-select" id="statusFilter" onchange="filterApplications()">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Cancelled">Cancelled</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="leaveTypeFilter" onchange="filterApplications()">
                <option value="">All Leave Types</option>
                {% for leave_type in leave_types %}
                <option value="{{ leave_type.id }}">{{ leave_type.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="date" class="form-control" id="dateFilter" onchange="filterApplications()">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Search employee..." id="employeeSearch">
        </div>
    </div>

    <!-- Applications Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Leave Applications</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Employee</th>
                                    <th>Leave Type</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Days</th>
                                    <th>Applied Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for application in applications %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="application-checkbox" value="{{ application.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <span class="badge bg-secondary">{{ application.employee.first_name[0] }}{{ application.employee.last_name[0] }}</span>
                                            </div>
                                            <div>
                                                <strong>{{ application.employee.first_name }} {{ application.employee.last_name }}</strong><br>
                                                <small class="text-muted">{{ application.employee.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ application.leave_type.name }}</td>
                                    <td>{{ application.start_date.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ application.end_date.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ application.total_days }}</td>
                                    <td>{{ application.applied_date.strftime('%m/%d/%Y') }}</td>
                                    <td>
                                        {% if application.status == 'Pending' %}
                                            <span class="badge bg-warning">{{ application.status }}</span>
                                        {% elif application.status == 'Approved' %}
                                            <span class="badge bg-success">{{ application.status }}</span>
                                        {% elif application.status == 'Rejected' %}
                                            <span class="badge bg-danger">{{ application.status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ application.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewApplication({{ application.id }})">
                                                <i data-feather="eye"></i>
                                            </button>
                                            {% if application.status == 'Pending' %}
                                            <button class="btn btn-outline-success" onclick="approveApplication({{ application.id }})">
                                                <i data-feather="check"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="rejectApplication({{ application.id }})">
                                                <i data-feather="x"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No leave applications found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Application Details Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Leave Application Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="applicationDetails">
                Loading application details...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="approveBtn" onclick="approveFromModal()">Approve</button>
                <button type="button" class="btn btn-danger" id="rejectBtn" onclick="rejectFromModal()">Reject</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Action Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Action</label>
                    <select class="form-select" id="bulkAction">
                        <option value="">Select action...</option>
                        <option value="approve">Approve Selected</option>
                        <option value="reject">Reject Selected</option>
                        <option value="export">Export Selected</option>
                    </select>
                </div>
                <div class="mb-3" id="commentSection" style="display: none;">
                    <label class="form-label">Comment</label>
                    <textarea class="form-control" id="bulkComment" rows="3" placeholder="Add a comment for this bulk action..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Execute Action</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentApplicationId = null;

function viewApplication(applicationId) {
    currentApplicationId = applicationId;
    const modal = new bootstrap.Modal(document.getElementById('applicationModal'));
    
    // Load application details via AJAX
    fetch(`/leave/application/${applicationId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('applicationDetails').innerHTML = formatApplicationDetails(data);
            modal.show();
        })
        .catch(error => {
            console.error('Error loading application details:', error);
        });
}

function approveApplication(applicationId) {
    if (confirm('Are you sure you want to approve this leave application?')) {
        fetch(`/leave/approve/${applicationId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error approving application: ' + data.message);
            }
        });
    }
}

function rejectApplication(applicationId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (reason) {
        fetch(`/leave/reject/${applicationId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error rejecting application: ' + data.message);
            }
        });
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.application-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function filterApplications() {
    const status = document.getElementById('statusFilter').value;
    const leaveType = document.getElementById('leaveTypeFilter').value;
    const date = document.getElementById('dateFilter').value;
    
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (leaveType) params.append('leave_type', leaveType);
    if (date) params.append('date', date);
    
    window.location.href = '?' + params.toString();
}

function executeBulkAction() {
    const action = document.getElementById('bulkAction').value;
    const comment = document.getElementById('bulkComment').value;
    const selectedApplications = Array.from(document.querySelectorAll('.application-checkbox:checked'))
        .map(checkbox => checkbox.value);
    
    if (!action || selectedApplications.length === 0) {
        alert('Please select an action and at least one application');
        return;
    }
    
    if (confirm(`Are you sure you want to ${action} ${selectedApplications.length} applications?`)) {
        fetch('/leave/bulk-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                applications: selectedApplications,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error executing bulk action: ' + data.message);
            }
        });
    }
}

function formatApplicationDetails(application) {
    return `
        <div class="row">
            <div class="col-md-6">
                <strong>Employee:</strong> ${application.employee_name}<br>
                <strong>Leave Type:</strong> ${application.leave_type}<br>
                <strong>Start Date:</strong> ${application.start_date}<br>
                <strong>End Date:</strong> ${application.end_date}<br>
                <strong>Total Days:</strong> ${application.total_days}
            </div>
            <div class="col-md-6">
                <strong>Applied Date:</strong> ${application.applied_date}<br>
                <strong>Status:</strong> ${application.status}<br>
                <strong>Current Balance:</strong> ${application.balance} days<br>
                <strong>Remaining After:</strong> ${application.remaining_balance} days
            </div>
        </div>
        <hr>
        <div class="mb-3">
            <strong>Reason:</strong><br>
            <p class="text-muted">${application.reason}</p>
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    
    // Show comment section for approve/reject actions
    document.getElementById('bulkAction').addEventListener('change', function() {
        const commentSection = document.getElementById('commentSection');
        if (this.value === 'approve' || this.value === 'reject') {
            commentSection.style.display = 'block';
        } else {
            commentSection.style.display = 'none';
        }
    });
});
</script>
{% endblock %}