{% extends "base.html" %}

{% block title %}Super Admin Dashboard - WFM System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i data-feather="shield" class="me-2"></i>
                Super Admin Dashboard
            </h2>
            <p class="text-muted mb-0">Complete system overview and management controls</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('dashboard_mgmt.configure_dashboards') }}" class="btn btn-outline-primary">
                <i data-feather="sliders" class="me-2"></i>
                Configure Dashboards
            </a>
            <button class="btn btn-primary" onclick="refreshAllData()">
                <i data-feather="refresh-cw" class="me-2"></i>
                Refresh Data
            </button>
        </div>
    </div>

    <!-- System Health Overview -->
    {% if 'system-health-section' in visible_sections %}
    <div class="row mb-4" id="system-health-section">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="activity" class="me-2"></i>
                        System Health & Performance
                    </h5>
                    <span class="badge bg-success">All Systems Operational</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-success">{{ system_stats.uptime or '99.9' }}%</div>
                                <small class="text-muted">System Uptime</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-info">{{ system_stats.active_users or 0 }}</div>
                                <small class="text-muted">Active Users Today</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-warning">{{ system_stats.pending_tasks or 0 }}</div>
                                <small class="text-muted">Pending System Tasks</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-primary">{{ system_stats.data_integrity or '100' }}%</div>
                                <small class="text-muted">Data Integrity Score</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Organization Overview -->
    {% if 'organization-overview-section' in visible_sections %}
    <div class="row mb-4" id="organization-overview-section">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="building-2" class="me-2"></i>
                        Organization Structure
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <div class="h4 text-primary">{{ org_stats.companies or 0 }}</div>
                                <small class="text-muted">Companies</small>
                            </div>
                            <div class="mb-3">
                                <div class="h4 text-info">{{ org_stats.regions or 0 }}</div>
                                <small class="text-muted">Regions</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <div class="h4 text-success">{{ org_stats.sites or 0 }}</div>
                                <small class="text-muted">Sites</small>
                            </div>
                            <div class="mb-3">
                                <div class="h4 text-warning">{{ org_stats.departments or 0 }}</div>
                                <small class="text-muted">Departments</small>
                            </div>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: {{ (org_stats.active_employees / org_stats.total_employees * 100) if org_stats.total_employees else 0 }}%"></div>
                    </div>
                    <small class="text-muted">{{ org_stats.active_employees or 0 }} of {{ org_stats.total_employees or 0 }} employees active</small>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="users" class="me-2"></i>
                        User Management Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-primary">{{ user_stats.super_users or 0 }}</div>
                                <small class="text-muted">Super Users</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-info">{{ user_stats.managers or 0 }}</div>
                                <small class="text-muted">Managers</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-success">{{ user_stats.employees or 0 }}</div>
                                <small class="text-muted">Employees</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Last Login Activity:</small>
                            <div class="text-success">{{ user_stats.recent_logins or 0 }} today</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Account Status:</small>
                            <div class="text-info">{{ user_stats.active_accounts or 0 }} active</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Time & Attendance Analytics -->
    {% if 'attendance-analytics-section' in visible_sections %}
    <div class="row mb-4" id="attendance-analytics-section">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="clock" class="me-2"></i>
                        Time & Attendance Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="trending-up" class="me-2"></i>
                        Today's Metrics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between">
                            <span>Clock-ins Today</span>
                            <strong class="text-success">{{ attendance_stats.clock_ins_today or 0 }}</strong>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: {{ (attendance_stats.clock_ins_today / attendance_stats.expected_clock_ins * 100) if attendance_stats.expected_clock_ins else 0 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between">
                            <span>On Time Arrivals</span>
                            <strong class="text-info">{{ attendance_stats.on_time_percentage or 0 }}%</strong>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-info" style="width: {{ attendance_stats.on_time_percentage or 0 }}%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between">
                            <span>Overtime Hours</span>
                            <strong class="text-warning">{{ attendance_stats.overtime_hours or 0 }}h</strong>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Exceptions</span>
                            <strong class="text-danger">{{ attendance_stats.exceptions or 0 }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Workflow & Automation Status -->
    {% if 'workflow-automation-section' in visible_sections %}
    <div class="row mb-4" id="workflow-automation-section">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="cpu" class="me-2"></i>
                        Automation & Workflows
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <div class="h4 text-success">{{ workflow_stats.active_workflows or 0 }}</div>
                                <small class="text-muted">Active Workflows</small>
                            </div>
                            <div class="mb-3">
                                <div class="h4 text-info">{{ workflow_stats.automation_rate or 0 }}%</div>
                                <small class="text-muted">Automation Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <div class="h4 text-warning">{{ workflow_stats.pending_approvals or 0 }}</div>
                                <small class="text-muted">Pending Approvals</small>
                            </div>
                            <div class="mb-3">
                                <div class="h4 text-primary">{{ workflow_stats.completed_today or 0 }}</div>
                                <small class="text-muted">Completed Today</small>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <a href="{{ url_for('automation.workflow_dashboard') }}" class="btn btn-outline-primary">
                            <i data-feather="settings" class="me-2"></i>
                            Manage Workflows
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <span class="me-2 fw-bold text-success">R</span>
                        Payroll & Financial Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <div class="h4 text-success">R{{ "{:,.2f}".format(payroll_stats.total_payroll or 0) }}</div>
                                <small class="text-muted">Current Period</small>
                            </div>
                            <div class="mb-3">
                                <div class="h4 text-info">{{ payroll_stats.overtime_cost or 0 }}%</div>
                                <small class="text-muted">Overtime Cost</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <div class="h4 text-warning">{{ payroll_stats.pending_calculations or 0 }}</div>
                                <small class="text-muted">Pending Calculations</small>
                            </div>
                            <div class="mb-3">
                                <div class="h4 text-primary">{{ payroll_stats.processed_employees or 0 }}</div>
                                <small class="text-muted">Processed Employees</small>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <a href="#" class="btn btn-outline-success">
                            <i data-feather="calculator" class="me-2"></i>
                            View Payroll
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Leave Management & Scheduling -->
    {% if 'leave-scheduling-section' in visible_sections %}
    <div class="row mb-4" id="leave-scheduling-section">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="calendar" class="me-2"></i>
                        Leave Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Pending Applications</span>
                            <strong class="text-warning">{{ leave_stats.pending_applications or 0 }}</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Approved This Month</span>
                            <strong class="text-success">{{ leave_stats.approved_month or 0 }}</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Leave Balance Issues</span>
                            <strong class="text-danger">{{ leave_stats.balance_issues or 0 }}</strong>
                        </div>
                    </div>
                    <div class="d-grid">
                        <a href="#" class="btn btn-outline-info">
                            <i data-feather="calendar-check" class="me-2"></i>
                            Manage Leave
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="calendar-range" class="me-2"></i>
                        Scheduling Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <div class="h4 text-primary">{{ schedule_stats.shifts_today or 0 }}</div>
                                <small class="text-muted">Shifts Today</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <div class="h4 text-success">{{ schedule_stats.coverage_rate or 0 }}%</div>
                                <small class="text-muted">Coverage Rate</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <div class="h4 text-warning">{{ schedule_stats.conflicts or 0 }}</div>
                                <small class="text-muted">Schedule Conflicts</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <div class="h4 text-info">{{ schedule_stats.upcoming_shifts or 0 }}</div>
                                <small class="text-muted">Upcoming Week</small>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <a href="{{ url_for('scheduling.manage_schedules') }}" class="btn btn-outline-primary">
                            <i data-feather="calendar" class="me-2"></i>
                            Manage Schedules
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- AI Insights & Reports -->
    {% if 'ai-insights-section' in visible_sections %}
    <div class="row mb-4" id="ai-insights-section">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="brain" class="me-2"></i>
                        AI Insights & Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="alert alert-info mb-2" role="alert">
                            <i data-feather="trending-up" class="me-2"></i>
                            <strong>Productivity Trend:</strong> 15% increase in average productivity this month
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-warning mb-2" role="alert">
                            <i data-feather="alert-triangle" class="me-2"></i>
                            <strong>Schedule Optimization:</strong> 3 departments could benefit from shift adjustments
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-success mb-2" role="alert">
                            <i data-feather="check-circle" class="me-2"></i>
                            <strong>Compliance Status:</strong> All departments meeting attendance requirements
                        </div>
                    </div>
                    <div class="d-grid">
                        <a href="{{ url_for('ai.ai_dashboard') }}" class="btn btn-outline-secondary">
                            <i data-feather="brain" class="me-2"></i>
                            View AI Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="bar-chart-3" class="me-2"></i>
                        Reports & Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('main.reports') }}?report_type=attendance&period=weekly" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            Attendance Summary Report
                            <span class="badge bg-primary rounded-pill">Weekly</span>
                        </a>
                        <a href="{{ url_for('payroll.time_summary_report') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            Payroll Analytics Report
                            <span class="badge bg-success rounded-pill">Monthly</span>
                        </a>
                        <a href="{{ url_for('main.reports') }}?report_type=performance" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            Performance Metrics
                            <span class="badge bg-info rounded-pill">Real-time</span>
                        </a>
                        <a href="{{ url_for('main.reports') }}?report_type=compliance&period=quarterly" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            Compliance Report
                            <span class="badge bg-warning rounded-pill">Quarterly</span>
                        </a>
                    </div>
                    <div class="d-grid mt-3">
                        <a href="{{ url_for('main.reports') }}" class="btn btn-outline-info">
                            <i data-feather="file-text" class="me-2"></i>
                            View All Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- System Alerts & Notifications -->
    {% if 'alerts-notifications-section' in visible_sections %}
    <div class="row mb-4" id="alerts-notifications-section">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="bell" class="me-2"></i>
                        System Alerts & Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <h6>Critical Alerts</h6>
                            <div class="alert alert-danger" role="alert">
                                <i data-feather="alert-circle" class="me-2"></i>
                                No critical alerts at this time
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <h6>System Warnings</h6>
                            <div class="alert alert-warning" role="alert">
                                <i data-feather="alert-triangle" class="me-2"></i>
                                Database backup scheduled for tonight
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <h6>Information</h6>
                            <div class="alert alert-info" role="alert">
                                <i data-feather="info" class="me-2"></i>
                                System performance optimized
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Dashboard Configuration Modal -->
<div class="modal fade" id="dashboardConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dashboard Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Configure which dashboard sections are visible for each user role:</p>
                <div id="dashboardConfigContent">
                    <!-- Configuration content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDashboardConfig()">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeAttendanceChart();
    refreshAllData();
    
    // Auto-refresh every 5 minutes
    setInterval(refreshAllData, 300000);
});

function initializeAttendanceChart() {
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Clock-ins',
                data: [120, 135, 142, 128, 156, 89, 45],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }, {
                label: 'On-time Rate',
                data: [95, 92, 88, 94, 91, 96, 98],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

function refreshAllData() {
    // Simulate data refresh
    console.log('Refreshing dashboard data...');
    
    // In a real implementation, this would make AJAX calls to refresh data
    setTimeout(() => {
        console.log('Dashboard data refreshed');
    }, 1000);
}

function saveDashboardConfig() {
    // Save dashboard configuration
    const config = getDashboardConfig();
    
    fetch('/dashboard/save-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Dashboard configuration saved successfully!');
            document.getElementById('dashboardConfigModal').querySelector('.btn-close').click();
        } else {
            alert('Error saving configuration: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error saving configuration: ' + error.message);
    });
}

function getDashboardConfig() {
    // Collect dashboard configuration from form
    const sections = document.querySelectorAll('[data-section-id]');
    const config = {};
    
    sections.forEach(section => {
        const sectionId = section.getAttribute('data-section-id');
        const roleCheckboxes = section.querySelectorAll('input[type="checkbox"]');
        config[sectionId] = {};
        
        roleCheckboxes.forEach(checkbox => {
            const role = checkbox.getAttribute('data-role');
            config[sectionId][role] = checkbox.checked;
        });
    });
    
    return config;
}
</script>

{% endblock %}