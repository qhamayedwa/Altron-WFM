{% extends "base.html" %}

{% block title %}Pay Rule Configuration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Pay Rule Configuration</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                        <i data-feather="plus" class="me-2"></i>Create Pay Rule
                    </button>
                    <button class="btn btn-outline-info" onclick="importRules()">
                        <i data-feather="upload" class="me-2"></i>Import Rules
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportRules()">
                        <i data-feather="download" class="me-2"></i>Export Rules
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pay Rule Categories -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ rule_stats.overtime or 0 }}</h4>
                    <small class="text-muted">Overtime Rules</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ rule_stats.regular or 0 }}</h4>
                    <small class="text-muted">Regular Pay Rules</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-warning">{{ rule_stats.bonus or 0 }}</h4>
                    <small class="text-muted">Bonus Rules</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info">{{ rule_stats.custom or 0 }}</h4>
                    <small class="text-muted">Custom Rules</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i data-feather="search"></i></span>
                <input type="text" class="form-control" placeholder="Search pay rules..." id="ruleSearch">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="categoryFilter" onchange="filterRules()">
                <option value="">All Categories</option>
                <option value="overtime">Overtime</option>
                <option value="regular">Regular Pay</option>
                <option value="bonus">Bonus</option>
                <option value="deduction">Deduction</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="statusFilter" onchange="filterRules()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="draft">Draft</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <i data-feather="refresh-cw"></i> Reset
            </button>
        </div>
    </div>

    <!-- Pay Rules Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Pay Rules</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Category</th>
                                    <th>Rate/Formula</th>
                                    <th>Conditions</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Last Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in pay_rules %}
                                <tr>
                                    <td>
                                        <strong>{{ rule.name }}</strong><br>
                                        <small class="text-muted">{{ rule.description }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if rule.category == 'overtime' else ('success' if rule.category == 'regular' else 'warning') }}">
                                            {{ rule.category.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if rule.rate_type == 'fixed' %}
                                            ${{ "%.2f"|format(rule.rate_value) }}
                                        {% elif rule.rate_type == 'multiplier' %}
                                            {{ rule.rate_value }}x Base Rate
                                        {% else %}
                                            Custom Formula
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if rule.conditions %}
                                                {{ rule.conditions[:50] }}...
                                            {% else %}
                                                No conditions
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ rule.priority or 0 }}</span>
                                    </td>
                                    <td>
                                        {% if rule.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rule.updated_at.strftime('%m/%d/%Y') if rule.updated_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewRule({{ rule.id }})">
                                                <i data-feather="eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="editRule({{ rule.id }})">
                                                <i data-feather="edit"></i>
                                            </button>
                                            <button class="btn btn-outline-info" onclick="testRule({{ rule.id }})">
                                                <i data-feather="play"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No pay rules configured</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Pay Rule Modal -->
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Pay Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('pay_rules.create_pay_rule') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rule Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select Category...</option>
                                    <option value="overtime">Overtime</option>
                                    <option value="regular">Regular Pay</option>
                                    <option value="bonus">Bonus</option>
                                    <option value="deduction">Deduction</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2" placeholder="Describe when this rule applies..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rate Type <span class="text-danger">*</span></label>
                                <select class="form-select" name="rate_type" onchange="toggleRateFields()" required>
                                    <option value="">Select Rate Type...</option>
                                    <option value="fixed">Fixed Amount</option>
                                    <option value="multiplier">Multiplier</option>
                                    <option value="formula">Custom Formula</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Rate Value <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="rate_value" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="formulaField" style="display: none;">
                        <label class="form-label">Custom Formula</label>
                        <textarea class="form-control" name="formula" rows="3" placeholder="Enter calculation formula..."></textarea>
                        <div class="form-text">Use variables like {hours}, {base_rate}, {overtime_hours}</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <input type="number" class="form-control" name="priority" value="0" min="0">
                                <div class="form-text">Higher numbers have higher priority</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-control" name="effective_date">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Conditions</label>
                        <textarea class="form-control" name="conditions" rows="3" placeholder="Define when this rule applies (optional)..."></textarea>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" checked id="isActive">
                        <label class="form-check-label" for="isActive">
                            Activate rule immediately
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-info" onclick="testNewRule()">Test Rule</button>
                    <button type="submit" class="btn btn-primary">Create Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rule Test Modal -->
<div class="modal fade" id="testRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Pay Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Test Hours</label>
                    <input type="number" class="form-control" id="testHours" value="40" step="0.1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Base Rate</label>
                    <input type="number" class="form-control" id="testBaseRate" value="15.00" step="0.01">
                </div>
                <div class="mb-3">
                    <label class="form-label">Test Results</label>
                    <div class="form-control-plaintext bg-light p-3 rounded" id="testResults">
                        Click "Run Test" to see calculation results
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runRuleTest()">Run Test</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleRateFields() {
    const rateType = document.querySelector('[name="rate_type"]').value;
    const formulaField = document.getElementById('formulaField');
    
    if (rateType === 'formula') {
        formulaField.style.display = 'block';
    } else {
        formulaField.style.display = 'none';
    }
}

function viewRule(ruleId) {
    window.location.href = `/pay-rules/view/${ruleId}`;
}

function editRule(ruleId) {
    window.location.href = `/pay-rules/edit/${ruleId}`;
}

function testRule(ruleId) {
    // Show test modal for specific rule
    const modal = new bootstrap.Modal(document.getElementById('testRuleModal'));
    modal.show();
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this pay rule? This action cannot be undone.')) {
        fetch(`/pay-rules/delete/${ruleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting rule: ' + data.message);
            }
        });
    }
}

function filterRules() {
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    const params = new URLSearchParams();
    if (category) params.append('category', category);
    if (status) params.append('status', status);
    
    window.location.href = '?' + params.toString();
}

function resetFilters() {
    window.location.href = window.location.pathname;
}

function testNewRule() {
    // Test the rule being created
    alert('Rule test functionality would validate the configuration');
}

function runRuleTest() {
    const hours = document.getElementById('testHours').value;
    const baseRate = document.getElementById('testBaseRate').value;
    
    // Simulate rule calculation
    const result = `
        <strong>Test Results:</strong><br>
        Regular Hours: ${Math.min(hours, 40)}<br>
        Overtime Hours: ${Math.max(0, hours - 40)}<br>
        Regular Pay: R${(Math.min(hours, 40) * baseRate).toFixed(2)}<br>
        Overtime Pay: R${(Math.max(0, hours - 40) * baseRate * 1.5).toFixed(2)}<br>
        <strong>Total Pay: R${(Math.min(hours, 40) * baseRate + Math.max(0, hours - 40) * baseRate * 1.5).toFixed(2)}</strong>
    `;
    
    document.getElementById('testResults').innerHTML = result;
}

function importRules() {
    // Import pay rules functionality
    alert('Import functionality would allow uploading rule configurations');
}

function exportRules() {
    window.location.href = '/pay-rules/export';
}

document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %}